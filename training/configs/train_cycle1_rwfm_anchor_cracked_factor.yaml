# ============================================================================
# Cycle-1 training config for Crab SmolVLA (fragile-object safe policy)
# Scope: pick_and_place_* + egg_carton_to_tray (clean set), optional cracked factor
# ============================================================================

experiment:
  name: "cycle1_rwfm_anchor_with_cracked"
  seed: 42
  output_dir: "outputs/cycle1_rwfm_anchor_with_cracked"
  resume_from_checkpoint: null

model:
  pretrained_path: "lerobot/smolvla_base"
  chunk_size: 50
  n_action_steps: 50
  max_state_dim: 32
  max_action_dim: 32
  action_dim: 14
  state_dim: 14
  num_steps: 10
  freeze_vision_encoder: true
  train_expert_only: true
  train_state_proj: true
  tactile_encoder:
    enabled: true
    input_dim: 100
    hidden_dim: 128
    output_dim: 64
    num_layers: 2
    activation: "gelu"
    dropout: 0.1

# Loss masking: use right arm joints for pick/place and carton opening tasks.
# Without this explicit mask, unknown tasks fall back to all joints.
task_masks:
  "Pick and place": [6, 7, 8, 9, 10, 11]
  "Open the carton": [6, 7, 8, 9, 10, 11]

dataset:
  # Resolved relative to `crab/training` by build_dataloaders
  episodes_dir: "../../"
  episode_names:
    - "egg_carton_to_tray/pick_place_soft_20260213_1921"
    - "egg_carton_to_tray/pick_place_soft_20260213_1936"
    - "egg_carton_to_tray/pick_place_soft_20260217_1847"
    - "egg_carton_to_tray/pick_place_soft_20260217_1905"
    - "egg_carton_to_tray/pick_place_soft_20260217_2003"
    - "egg_carton_to_tray/pick_place_soft_20260217_2020"
    - "egg_carton_to_tray/pick_place_soft_20260218_1414"
    - "egg_carton_to_tray/pick_place_soft_20260218_1422"
    - "egg_carton_to_tray/pick_place_soft_20260218_1429"
    - "egg_carton_to_tray/pick_place_soft_20260218_1446"
    - "egg_carton_to_tray/pick_place_soft_20260219_1759"
    - "pick_and_place_bottle/pick_place_medium_20260211_1405"
    - "pick_and_place_bottle/pick_place_medium_20260211_1453"
    - "pick_and_place_bottle/pick_place_medium_20260211_1502"
    - "pick_and_place_bottle/pick_place_medium_20260211_1510"
    - "pick_and_place_bottle/pick_place_medium_20260211_1651"
    - "pick_and_place_bottle/pick_place_medium_20260211_1702"
    - "pick_and_place_bottle/pick_place_medium_20260211_1709"
    - "pick_and_place_bottle/pick_place_medium_20260211_1717"
    - "pick_and_place_bottle/pick_place_medium_20260211_1729"
    - "pick_and_place_bottle/pick_place_medium_20260211_1729_2"
    - "pick_and_place_can/pick_place_medium_20260210_1541"
    - "pick_and_place_can/pick_place_medium_20260210_1549"
    - "pick_and_place_can/pick_place_medium_20260210_1558"
    - "pick_and_place_can/pick_place_medium_20260210_1622"
    - "pick_and_place_can/pick_place_medium_20260210_1627"
    - "pick_and_place_can/pick_place_medium_20260210_1640"
    - "pick_and_place_can/pick_place_medium_20260210_1955"
    - "pick_and_place_can/pick_place_medium_20260210_2004"
    - "pick_and_place_can/pick_place_medium_20260210_2011"
    - "pick_and_place_can/pick_place_medium_20260210_2020"
    - "pick_and_place_can/pick_place_medium_20260210_2032"
    - "pick_and_place_waffle/pick_place_soft_20260212_1703"
    - "pick_and_place_waffle/pick_place_soft_20260212_1719"
    - "pick_and_place_waffle/pick_place_soft_20260212_1732"
    - "pick_and_place_waffle/pick_place_soft_20260212_1822"
    - "pick_and_place_waffle/pick_place_soft_20260212_1832"
    - "pick_and_place_waffle/pick_place_soft_20260212_1839"
    - "pick_and_place_waffle/pick_place_soft_20260212_1846"
    - "pick_and_place_waffle/pick_place_soft_20260212_1851"
    - "pick_and_place_waffle/pick_place_soft_20260212_1856"
    - "pick_and_place_waffle/pick_place_soft_20260212_1902"
    - "pick_and_place_waffle/pick_place_soft_20260212_1912"
    - "pick_and_place_waffle/pick_place_soft_20260212_1959"
    - "pick_and_place_waffle/pick_place_soft_20260212_2031"
    - "pick_and_place_waffle/pick_place_soft_20260212_2043"
    - "egg_carton_to_tray_cracked/pick_place_soft_20260219_1820"
    - "egg_carton_to_tray_cracked/pick_place_soft_20260219_1831"
    - "egg_carton_to_tray_cracked/pick_place_soft_20260219_1839"
  action_key: "action"
  state_key: "observation.state"
  tactile_left_key: "observation.tactile_left"
  tactile_right_key: "observation.tactile_right"
  image_keys:
    - "observation.images.main_camera"
    - "observation.images.left_arm_camera"
    - "observation.images.right_arm_camera"
  fps: 15
  image_size: [256, 256]
  original_image_size: [480, 640]
  video_codec: "av1"
  task_description: "Pick and place object"
  val_ratio: 0.1
  num_workers: 0
  chunk_return_gamma: 0.99
  video_cache_dir: "../../.cache/crab_video_cache"

training:
  batch_size: 8
  gradient_accumulation_steps: 2
  steps: 50000
  warmup_steps: 2000
  optimizer: "adamw"
  learning_rate: 1.0e-4
  weight_decay: 1.0e-10
  betas: [0.9, 0.95]
  eps: 1.0e-8
  grad_clip_norm: 10.0
  scheduler: "cosine_with_warmup"
  decay_steps: 50000
  min_lr: 2.5e-6
  use_amp: true
  amp_dtype: "bfloat16"
  checkpoint:
    save_every_steps: 5000
    keep_last_n: 5
    save_optimizer: true
    save_best: true
  log_every_steps: 50
  eval_every_steps: 2500
  visualize_every_steps: 1000

reward_weighting:
  enabled: true
  alpha: 0.25
  alpha_warmup_steps: 1000
  alpha_ramp_steps: 3000
  w_min: 0.25
  w_max: 4.0
  mix_beta: 0.7
  z_clip: 6.0
  a_clip: 6.0
  group_key: "task"
  eps: 1.0e-6
  stats_path: "docs/reward_weighting_stats_cycle1_with_cracked.json"

anchor:
  enabled: true
  lambda: 1.0e-4
  warmup_steps: 2000
  ramp_steps: 6000
  trainable_only: true
  reference_device: "cpu"
